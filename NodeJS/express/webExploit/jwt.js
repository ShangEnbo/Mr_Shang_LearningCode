// 导入 express 模块
const express = require('express')

// 创建 express 的服务器实例
const app = express()

const jwt = require('jsonwebtoken')
const expressJWT = require('express-jwt')

const secretkey = 'itheima No1 ^_^'

app.use(expressJWT({ 
  secret: secretkey,
  algorithms: ['HS256'] // HS256/RS256
}).unless({ 
  path: [/^\/api\//] 
}))

app.use(express.urlencoded({ extended: false }))

// 登录接口
app.post('/api/login', (req, res) => {
  if(req.body.username !== 'admin' || req.body.password !== '000000') {
    return res.send({ status: 1, msg: '登录失败' })
  }
  const userinfo = req.body

  // 生成jwt字符串
  /**
   * 参数1 用户的信息对象
   * 参数2 加密的密钥
   * 参数3 配置对象，可以配置当前token的有效期
   */
  const tokenstr = jwt.sign({secretkey, username: userinfo.username}, { expiresIn: '60s' })
  res.send({
    status: 0,
    msg: '登录成功',
    data: tokenstr
  })
})

// 获取用户的名字
app.get('/user/username', (req, res) => {
  
  res.send({
    status: 0,
    msg: 'success',
    data: req.user
  })
})

// 捕获错误信息
app.use((err, req, res, next) => {
  if(err.name === 'UnauthorizedError') {
    return res.send({ status: 401, message: '无效的token' })
  }
  // 其他原因导致的错误
  res.send({ status: 500, message: '未知错误' })
})

app.listen(3011)
app.listen(3012)
